generator client {
  provider     = "prisma-client-js"
  moduleFormat = "cjs"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  extensions = [vector] // pgvector 확장 선언
}

model User {
  id                  String            @id @default(uuid())
  email               String            @unique
  password            String
  name                String?
  role                Role              @default(STARGAZER)
  
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  uploads             KnowledgeDoc[]
  vectorized          VectorizedDoc[]

  @@map("users")
}

model KnowledgeDoc {
  id                  String            @id @default(uuid())
  title               String
  originalFilename    String            @map("original_filename")
  fileSize            Int               @map("file_size")
  mimeType            String            @map("mime_type")

  minioBucket         String            @map("minio_bucket")
  minioKey            String            @map("minio_key")

  status              DocStatus         @default(UPLOADED)
  version             Int               @default(1)
  contentHash         String            @map("content_hash")
  errorMessage        String?           @map("error_message")

  uploaderId          String            @map("uploader_id")
  uploader            User              @relation(fields: [uploaderId], references: [id])


  vectors             VectorizedDoc[]
  metaData            Json?             @map("meta_data")

  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  @@map("knowledge_docs")
}

model VectorizedDoc {
  id                  String            @id @default(uuid())

  // 청크 순서 (정렬 및 앞뒤 문맥 파악용)
  chunkIndex          Int               @map("chunk_index")

  // 실제 텍스트 내용
  content             String            @db.Text

  // 유연한 메타데이터
  metaData            Json?             @map("meta_data")

  // 프롬프트 길이 계산용 
  tokenCount          Int               @default(0) @map("token_count")

  // 벡터 데이터
  embedding           Unsupported("vector(1536)")?

  // 임베딩 모델
  embeddingModel      String            @default("openai") @map("embedding_model")
  
  // 원본 데이터와 관계 설정, 삭제 시 삭제 되도록 처리
  knowledgeDocId      String            @map("knowledge_doc_id")
  knowledgeDoc        KnowledgeDoc      @relation(fields: [knowledgeDocId], references: [id], onDelete: Cascade)

  uploaderId          String            @map("uploader_id")
  uploader            User              @relation(fields: [uploaderId], references: [id])

  createdAt           DateTime          @default(now()) @map("created_at")

  @@map("vectorized_docs")
  //@@index([embedding], type: Hnsw) // pgvector indexing 
}

enum Role {
  ADMIN
  STARGAZER
  PROTOSTAR
}

enum DocStatus {
  UPLOADED
  PROCESSING
  COMPLETED
  FAILED
}